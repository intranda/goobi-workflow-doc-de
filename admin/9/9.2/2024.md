# 2024

## 24.07

### Vokabulare
Falls Vokabulare verwendet werden sollen oder vor einem Update verwendet wurden, müssen hier Anpassungen vorgenommen werden. Prüfen, ob Vokabulare genutzt werden:
```bash
sudo mysql goobi -NBse 'select count(1) from vocabulary_record_data'
```
Wenn dieser Befehl eine Zahl >0 liefert, ist dringend empfohlen, **VOR** dem Goobi workflow-Update die Vokabular-Migration zu testen.

Die Vokabularverwaltung von Goobi workflow wurde durch den Vokabularserver abgelöst. Das ist eine eigenständige Applikation, mit der Goobi workflow kommunizieren kann.
Bitte lesen Sie die Details in der [Dokumentation des Vokabularservers](https://github.com/intranda/goobi-vocabulary-server/blob/develop/docs/de/README.md) nach.

### Update Archivverwaltung
Dieser Punkt betrifft Installationen, die das Archivmanagement-Plugin verwenden. Prüfen, ob dieses installiert ist:
```bash
ls -ahl /opt/digiverso/goobi/plugins/administration/*archive*management*jar
```

Die Daten der Archivverwaltung werden nicht mehr in einer BaseX-Datenbank gespeichert, sondern in die Goobi workflow-Datenbank migriert.
Beim Update müssen die folgenden Punkte abgearbeitet werden:

1. Der aktuelle Zustand der Archive muss gesichert werden. Dafür unter https://URL/basex/dba/login einloggen. Dann unter Databases jede Datenbank auswählen, die .xml-Dateien auswählen und herunterladen.
2. BaseX stoppen:
```bash
systemctl stop basexhttp.service
```
3. Konfiguration anpassen: 
Öffnen Sie die Datei `/opt/digiverso/goobi/config/plugin_intranda_administration_archive_management.xml` und entfernen Sie die folgenden Zeilen:
```xml
<basexUrl>http://localhost:8984/</basexUrl>
<eadExportFolder>/opt/digiverso/basex/import</eadExportFolder>
```
Fügen Sie stattdessen die folgenden Blöcke hinzu:
```xml
    <export>
        <!-- examples -->
        <!--
        <file name="archive1.xml">
            <folder>/opt/digiverso/viewer/hotfolder/</folder>
        </file>
        <file name="archive2.xml">
            <folder>/opt/digiverso/viewer01/hotfolder/</folder>
            <folder>/opt/digiverso/viewer02/hotfolder/</folder>
        </file>
        -->
    </export>
    <backup>
        <!-- backup folder -->
        <folder>/tmp/</folder>
        <!-- number of backups for each inventory -->
        <numberOfFiles>10</numberOfFiles>
        <!-- tool to create the backup files -->
        <tool>/usr/bin/mysqldump</tool>
        <!-- database password. The user name, database name, tables etc. can be recognised automatically, but the password must be entered.-->
        <!-- Leave empty if access is possible without authentication (e.g. configured in ~/.my.cnf)  -->
        <password></password>
    </backup>
```
4. Rechte anpassen: 
Nach dem Update müssen die folgenden Rechte für den vollständigen Zugriff vorhanden sein:
``` 
Plugin_Administration_Archive_Management
Plugin_Administration_Archive_Management_Write
Plugin_Administration_Archive_Management_Upload
Plugin_Administration_Archive_Management_New
Plugin_Administration_Archive_Management_Vocabulary
Plugin_Administration_Archive_Management_All_Inventories
Plugin_Administration_Archive_Management_Delete
```

5. Archiv-Plugin öffnen und EAD-Dateien importieren.
6. Optional: Export für den Viewer konfigurieren:
Ob schon EAD Dateien im Viewer vorhanden sind, kann unter `VIEWERURL/archives/` nachgeschaut werden.
Falls die EAD-Dateien auch im Viewer sichtbar sein sollen, konfigurieren Sie den `<export>`-Bereich. Zu exportierende Dateien und der Hotfolder müssen dort angegeben werden.
7. Automatische Aufgaben einrichten:
Führen Sie folgenden Befehl aus, um automatische Exporte zu konfigurieren:
```bash
echo -e "\n#Automatic export archive\nintranda_quartz_exportEadFile=0 0 0 * * ?" >> /opt/digiverso/goobi/config/goobi_config.properties
```
8. BaseX deinstallieren:
Nachdem das Goobi workflow-Update erfolgreich getestet wurde und die Archive wie gewünscht funktionieren, kann BaseX deinstalliert werden:
```bash
BAK=/home/intranda/BACKUP/$(date -I) && mkdir $BAK -p
mv /etc/systemd/system/basexhttp.service $BAK
mv /opt/digiverso/basex/ $BAK
systemctl daemon-reload
``` 
Entfernen Sie zusätzlich den folgenden Block aus der Apache-Konfiguration:
```
    redirect 301 /basex http://example.com/basex/
    <Location /basex/>
            Require ip 1.2.3.4
            ProxyPass http://localhost:8984/ retry=0
            ProxyPassReverse http://localhost:8984/
    </Location>
```

### AdjustmAnpassungen an der Konfiguration des goobi-plugin-export-configurable-Plugins
Einige Tag-Namen haben sich geändert. Sie können mit dem folgenden Kommando angepasst werden:
```bash
xmlstarlet ed --inplace \
              -r //config/folder     -v includeFolders \
              -r //includeMedia      -v media \
              -r //includeMaster     -v master \
              -r //includeOcr        -v ocr \
              -r //includeSource     -v source \
              -r //includeImport     -v import \
              -r //includeExort      -v export \
              -r //includeITM        -v itm \
              -r //includeValidation -v validation \
              /opt/digiverso/goobi/config/plugin_intranda_export_configurable.xml
```

## 24.04

### Anpassungen an der Konfiguration des newspaperRecognizer-Plugins

Die Config Datei `plugin_intranda_step_newspaperRecognizer.xml` muss der folgende Block vorhanden sein:
```
<config_plugin>
	<defaultDepth>1</defaultDepth>
	<loadAllImages>true</loadAllImages>
	<showWriteMetsButton>true</showWriteMetsButton>
    <showDeletePageButton>false</showDeletePageButton>
	<dateFormatDelimiter>.</dateFormatDelimiter>
	<writePageTitle>true</writePageTitle>
    
	<pagination>
		<createNewPagination>true</createNewPagination>
		<type>1</type>
		<useFakePagination>false</useFakePagination>
	</pagination>
</config_plugin>
```
Dabei muss die vorhandene Konfiguration übernommen werden.

### Anpassungen an der Archive Management Config

Wenn in `/opt/digiverso/goobi/config/plugin_intranda_administration_archive_management.xml` folgendes steht:
```
<useShelfmark>true</useShelfmark>
```
muss dies durch das folgende Ersetzt werden:
```
<title name="shelfmarksource" type="NORMAL" />
<title name="TitleDocMain" type="CAMEL_CASE" />
```
Wenn useShelfmark auf false steht, muss nichts angepasst werden.

## 24.02

### Config Editor im Core
Mit der neuen Version ist das Plugin für den Konfigurationseditor in den Goobi workflow core integriert worden. Dazu müssen bei einem Update einige Punkte beachtet werden: Das alte Plugin muss gelöscht werden, und die Konfigurationsdatei muss umbenannt werden.

```bash
rm /opt/digiverso/goobi/plugins/administration/plugin_intranda_administration_config_file_editor.jar
rm /opt/digiverso/goobi/plugins/GUI/plugin_intranda_administration_config_file_editor-GUI.jar
cd /opt/digiverso/goobi/config/
if [ -f "plugin_intranda_administration_config_file_editor.xml" ]; then
    mv -i plugin_intranda_administration_config_file_editor.xml goobi_configeditor.xml
else
    if [ ! -f "goobi_configeditor.xml" ]; then
        wget https://raw.githubusercontent.com/intranda/goobi-workflow/master/install/config/goobi_configeditor.xml
    fi
fi
```

Korrektur des Berechtigungsnamens:
```bash
mysql goobi -NBse "update benutzergruppen set roles=REPLACE(roles,'Plugin_administration_config_file_editor','Admin_config_file_editor') where roles regexp 'Plugin_administration_config_file_editor'"
```

### Anpassungen an plugin\_step\_rename\_files
In dem Plugin wurde Funktionalität zum Konfigurieren ergänzt. Damit sich das Plugin nach dem Update gleich verhält, muss auch der folgende Block in jedem `<config>...</config>` ergänzt werden:

```bash
	<namepart type="counter">
            0000
            <condition value="{originalfilename}" matches="^(?!.*barcode).*$" />
        </namepart>
        <namepart type="static">
            0000
            <condition value="{originalfilename}" matches="^.*barcode.*$" />
        </namepart>
```
